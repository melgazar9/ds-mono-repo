{{ config(schema='yf_core', materialized='incremental', unique_key=['day', 'ticker']) }}

with cte as (
  select
    date(spi.timestamp) as day,
    spi.timestamp_tz_aware,
    spi.timezone,
    spi.ticker,
    spi.open,
    spi.high,
    spi.low,
    spi.close,
    spi.volume,
    spi.dividends,
    spi.stock_splits,
    a.dividends as actions_dividends,
    a.stock_splits as actions_stock_splits,
    bs.capital_stock,
    bs.current_capital_lease_obligation,
    bs.payables_and_accrued_expenses,
    bs.leases,
    bs.common_stock,
    bs.other_current_borrowings,
    bs.other_current_liabilities,
    bs.machinery_furniture_equipment,
    bs.working_capital,
    bs.other_equity_adjustments,
    bs.total_debt,
    bs.inventory,
    bs.gains_losses_not_affecting_retained_earnings,
    bs.current_deferred_revenue,
    bs.cash_financial,
    bs.retained_earnings,
    bs.current_debt_and_capital_lease_obligation,
    bs.other_non_current_assets,
    bs.capital_lease_obligations,
    bs.total_non_current_liabilities_net_minority_interest,
    bs.cash_equivalents,
    bs.payables,
    bs.prepaid_assets,
    bs.available_for_sale_securities,
    bs.tangible_book_value,
    bs.gross_accounts_receivable,
    bs.investments_and_advances,
    bs.other_current_assets,
    bs.other_intangible_assets,
    bs.accounts_receivable,
    bs.total_non_current_assets,
    bs.net_debt,
    bs.net_ppe,
    bs.land_and_improvements,
    bs.investmentin_financial_assets,
    bs.other_receivables,
    bs.long_term_debt_and_capital_lease_obligation,
    bs.cash_cash_equivalents_and_short_term_investments,
    bs.stockholders_equity,
    bs.total_liabilities_net_minority_interest,
    bs.ordinary_shares_number,
    bs.other_properties,
    bs.share_issued,
    bs.receivables,
    bs.cash_and_cash_equivalents,
    bs.long_term_debt,
    bs.commercial_paper,
    bs.accumulated_depreciation,
    bs.treasury_shares_number,
    bs.current_liabilities,
    bs.dueto_related_parties_current,
    bs.allowance_for_doubtful_accounts_receivable,
    bs.construction_in_progress,
    bs.current_assets,
    bs.buildings_and_improvements,
    bs.goodwill,
    bs.common_stock_equity,
    bs.other_payable,
    bs.properties,
    bs.additional_paid_in_capital,
    bs.total_assets,
    bs.other_investments,
    bs.total_equity_gross_minority_interest,
    bs.pensionand_other_post_retirement_benefit_plans_current,
    bs.long_term_capital_lease_obligation,
    bs.invested_capital,
    bs.total_capitalization,
    bs.goodwill_and_other_intangible_assets,
    bs.long_term_equity_investment,
    bs.current_debt,
    bs.accounts_payable,
    bs.other_non_current_liabilities,
    bs.total_tax_payable,
    bs.current_accrued_expenses,
    bs.current_deferred_liabilities,
    bs.tradeand_other_payables_non_current,
    bs.gross_ppe,
    bs.other_short_term_investments,
    bs.net_tangible_assets,
    bs.minority_interest,
    bs.other_equity_interest,
    bs.non_current_pension_and_other_postretirement_benefit_plans,
    bs.non_current_deferred_taxes_liabilities,
    bs.current_provisions,
    bs.non_current_prepaid_assets,
    bs.non_current_deferred_taxes_assets,
    bs.financial_assets,
    bs.financial_assets_designatedas_fair_value_through_profitor_loss_,
    bs.investmentsin_associatesat_cost,
    bs.hedging_assets_current,
    bs.finished_goods,
    bs.work_in_process,
    bs.raw_materials,
    bs.taxes_receivable,
    bs.preferred_shares_number,
    bs.preferred_stock_equity,
    bs.preferred_stock,
    bs.derivative_product_liabilities,
    bs.non_current_deferred_revenue,
    bs.long_term_provisions,
    bs.investments_in_other_ventures_under_equity_method,
    bs.investment_properties,
    bs.assets_held_for_sale_current,
    bs.inventories_adjustments_allowances,
    bs.other_inventories,
    bs.fixed_assets_revaluation_reserve,
    bs.held_to_maturity_securities,
    bs.investmentsin_joint_venturesat_cost,
    bs.receivables_adjustments_allowances,
    bs.defined_pension_benefit,
    bs.non_current_accrued_expenses,
    bs.treasury_stock,
    bs.investmentsin_subsidiariesat_cost,
    bs.restricted_cash,
    bs.current_deferred_taxes_liabilities,
    bs.employee_benefits,
    bs.non_current_deferred_liabilities,
    bs.dividends_payable,
    bs.income_tax_payable,
    bs.non_current_deferred_assets,
    bs.non_current_accounts_receivable,
    bs.trading_securities,
    bs.line_of_credit,
    bs.interest_payable,
    bs.non_current_note_receivables,
    bs.loans_receivable,
    bs.preferred_securities_outside_stock_equity,
    bs.duefrom_related_parties_non_current,
    bs.duefrom_related_parties_current,
    bs.accrued_interest_receivable,
    bs.current_deferred_assets,
    bs.foreign_currency_translation_adjustments,
    bs.liabilities_heldfor_sale_non_current,
    bs.current_deferred_taxes_assets,
    bs.minimum_pension_liabilities,
    bs.current_notes_payable,
    bs.notes_receivable,
    bs.unrealized_gain_loss,
    bs.general_partnership_capital,
    bs.limited_partnership_capital,
    bs.total_partnership_capital,
    bs.dueto_related_parties_non_current,
    bs.restricted_common_stock,
    bs.other_capital_stock,
    bs.financial_assets_designatedas_fv_thru_profitor_loss_total,
    cd.dividend_date,
    cd.ex_dividend_date,
    ce.earnings_date,
    ce.earnings_high,
    ce.earnings_low,
    ce.earnings_average,
    ce.revenue_high,
    ce.revenue_low,
    ce.revenue_average,
    cf.beginning_cash_position,
    cf.capital_expenditure,
    cf.cash_flow_from_continuing_financing_activities,
    cf.cash_flow_from_continuing_investing_activities,
    cf.cash_flow_from_continuing_operating_activities,
    cf.change_in_account_payable,
    cf.change_in_inventory,
    cf.change_in_other_current_assets,
    cf.change_in_other_current_liabilities,
    cf.change_in_payable,
    cf.change_in_payables_and_accrued_expense,
    cf.change_in_receivables,
    cf.change_in_working_capital,
    cf.changes_in_account_receivables,
    cf.changes_in_cash,
    cf.common_stock_payments,
    cf.depreciation_amortization_depletion,
    cf.depreciation_and_amortization,
    cf.end_cash_position,
    cf.financing_cash_flow,
    cf.free_cash_flow,
    cf.income_tax_paid_supplemental_data,
    cf.interest_paid_supplemental_data,
    cf.investing_cash_flow,
    cf.issuance_of_debt,
    cf.long_term_debt_issuance,
    cf.long_term_debt_payments,
    cf.net_common_stock_issuance,
    cf.net_income_from_continuing_operations,
    cf.net_investment_purchase_and_sale,
    cf.net_issuance_payments_of_debt,
    cf.net_long_term_debt_issuance,
    cf.net_other_financing_charges,
    cf.net_other_investing_changes,
    cf.net_ppe_purchase_and_sale,
    cf.operating_cash_flow,
    cf.other_non_cash_items,
    cf.purchase_of_investment,
    cf.purchase_of_ppe,
    cf.repayment_of_debt,
    cf.repurchase_of_capital_stock,
    cf.sale_of_investment,
    cf.stock_based_compensation,
    cf.purchase_of_business,
    cf.sale_of_ppe,
    cf.common_stock_dividend_paid,
    cf.deferred_tax,
    cf.change_in_other_working_capital,
    cf.change_in_prepaid_assets,
    cf.cash_dividends_paid,
    cf.effect_of_exchange_rate_changes,
    cf.short_term_debt_payments,
    cf.deferred_income_tax,
    cf.net_business_purchase_and_sale,
    cf.unrealized_gain_loss_on_investment_securities,
    cf.asset_impairment_charge,
    cf.change_in_accrued_expense,
    cf.amortization_cash_flow,
    cf.depreciation,
    cf.dividend_received_cfo,
    cf.gain_loss_on_investment_securities,
    cf.gain_loss_on_sale_of_ppe,
    cf.interest_paid_cfo,
    cf.interest_received_cfo,
    cf.net_foreign_currency_exchange_gain_loss,
    cf.net_intangibles_purchase_and_sale,
    cf.net_investment_properties_purchase_and_sale,
    cf.other_cash_adjustment_outside_changein_cash,
    cf.pension_and_employee_benefit_expense,
    cf.provisionand_write_offof_assets,
    cf.purchase_of_intangibles,
    cf.purchase_of_investment_properties,
    cf.sale_of_intangibles,
    cf.short_term_debt_issuance,
    cf.taxes_refund_paid,
    cf.classesof_cash_payments,
    cf.cash_flowsfromusedin_operating_activities_direct,
    cf.classesof_cash_receiptsfrom_operating_activities,
    cf.interest_paid_cff,
    cf.interest_received_cfi,
    cf.other_cash_paymentsfrom_operating_activities,
    cf.paymentson_behalfof_employees,
    cf.paymentsto_suppliersfor_goodsand_services,
    cf.receiptsfrom_customers,
    cf.taxes_refund_paid_direct,
    cf.sale_of_business,
    cf.common_stock_issuance,
    cf.issuance_of_capital_stock,
    cf.sale_of_investment_properties,
    cf.dividends_received_cfi,
    cf.amortization_of_intangibles,
    cf.operating_gains_losses,
    cf.proceeds_from_stock_option_exercised,
    cf.capital_expenditure_reported,
    cf.interest_paid_direct,
    cf.earnings_losses_from_equity_investments,
    cf.gain_loss_on_sale_of_business,
    cf.other_cash_adjustment_inside_changein_cash,
    cf.net_preferred_stock_issuance,
    cf.preferred_stock_issuance,
    cf.amortization_of_securities,
    cf.change_in_income_tax_payable,
    cf.change_in_tax_payable,
    cf.dividend_paid_cfo,
    cf.preferred_stock_dividend_paid,
    cf.cash_from_discontinued_operating_activities,
    cf.preferred_stock_payments,
    cf.cash_from_discontinued_investing_activities,
    cf.change_in_interest_payable,
    cf.cash_from_discontinued_financing_activities,
    cf.other_cash_receiptsfrom_operating_activities,
    cf.cash_flow_from_discontinued_operation,
    cf.interest_received_direct,
    cf.excess_tax_benefit_from_stock_based_compensation,
    cf.depletion,
    cf.change_in_dividend_payable,
    cf.receiptsfrom_government_grants,
    cf.dividends_received_direct,
    cf.net_short_term_debt_issuance,
    cf.dividends_paid_direct,
    d.dividends as d_dividends
  from
    {{ ref('yf_stock_prices_1d') }} spi
  left join {{ ref('yf_actions') }} a on spi.ticker = a.ticker and date(spi.timestamp) = date(a.timestamp)
  left join {{ ref('yf_balance_sheet') }} bs on spi.ticker = bs.ticker and date(spi.timestamp) = date(bs.date)
  left join (select distinct dividend_date, ex_dividend_date, ticker from {{ ref('yf_calendar') }}) cd on spi.ticker = cd.ticker and date(spi.timestamp) = date(cd.dividend_date)
  left join (select distinct ticker, earnings_date, earnings_high, earnings_low, earnings_average, revenue_high, revenue_low, revenue_average from {{ ref('yf_calendar') }}) ce on spi.ticker = ce.ticker and date(spi.timestamp) = date(ce.earnings_date)
  left join {{ ref('yf_cash_flow') }} cf on spi.ticker = cf.ticker and date(spi.timestamp) = date(cf.date)
  left join {{ ref('yf_dividends') }} d on spi.ticker = d.ticker and date(spi.timestamp) = date(d.timestamp)
)

select * from cte