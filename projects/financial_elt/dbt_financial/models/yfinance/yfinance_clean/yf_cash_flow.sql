{{ config(schema='yfinance', materialized='incremental', unique_key=['timestamp', 'ticker']) }}

with cte as (
  select
    date,
    ticker,
    beginning_cash_position,
    capital_expenditure,
    cash_flow_from_continuing_financing_activities,
    cash_flow_from_continuing_investing_activities,
    cash_flow_from_continuing_operating_activities,
    change_in_account_payable,
    change_in_inventory,
    change_in_other_current_assets,
    change_in_other_current_liabilities,
    change_in_payable,
    change_in_payables_and_accrued_expense,
    change_in_receivables,
    change_in_working_capital,
    changes_in_account_receivables,
    changes_in_cash,
    common_stock_payments,
    depreciation_amortization_depletion,
    depreciation_and_amortization,
    end_cash_position,
    financing_cash_flow,
    free_cash_flow,
    income_tax_paid_supplemental_data,
    interest_paid_supplemental_data,
    investing_cash_flow,
    issuance_of_debt,
    long_term_debt_issuance,
    long_term_debt_payments,
    net_common_stock_issuance,
    net_income_from_continuing_operations,
    net_investment_purchase_and_sale,
    net_issuance_payments_of_debt,
    net_long_term_debt_issuance,
    net_other_financing_charges,
    net_other_investing_changes,
    net_ppe_purchase_and_sale,
    operating_cash_flow,
    other_non_cash_items,
    purchase_of_investment,
    purchase_of_ppe,
    repayment_of_debt,
    repurchase_of_capital_stock,
    sale_of_investment,
    stock_based_compensation,
    purchase_of_business,
    sale_of_ppe,
    common_stock_dividend_paid,
    deferred_tax,
    change_in_other_working_capital,
    change_in_prepaid_assets,
    cash_dividends_paid,
    effect_of_exchange_rate_changes,
    short_term_debt_payments,
    deferred_income_tax,
    net_business_purchase_and_sale,
    unrealized_gain_loss_on_investment_securities,
    asset_impairment_charge,
    change_in_accrued_expense,
    amortization_cash_flow,
    depreciation,
    dividend_received_cfo,
    gain_loss_on_investment_securities,
    gain_loss_on_sale_of_ppe,
    interest_paid_cfo,
    interest_received_cfo,
    net_foreign_currency_exchange_gain_loss,
    net_intangibles_purchase_and_sale,
    net_investment_properties_purchase_and_sale,
    other_cash_adjustment_outside_changein_cash,
    pension_and_employee_benefit_expense,
    provisionand_write_offof_assets,
    purchase_of_intangibles,
    purchase_of_investment_properties,
    sale_of_intangibles,
    short_term_debt_issuance,
    taxes_refund_paid,
    classesof_cash_payments,
    cash_flowsfromusedin_operating_activities_direct,
    classesof_cash_receiptsfrom_operating_activities,
    interest_paid_cff,
    interest_received_cfi,
    other_cash_paymentsfrom_operating_activities,
    paymentson_behalfof_employees,
    paymentsto_suppliersfor_goodsand_services,
    receiptsfrom_customers,
    taxes_refund_paid_direct,
    sale_of_business,
    common_stock_issuance,
    issuance_of_capital_stock,
    sale_of_investment_properties,
    dividends_received_cfi,
    amortization_of_intangibles,
    operating_gains_losses,
    proceeds_from_stock_option_exercised,
    capital_expenditure_reported,
    interest_paid_direct,
    earnings_losses_from_equity_investments,
    gain_loss_on_sale_of_business,
    other_cash_adjustment_inside_changein_cash,
    net_preferred_stock_issuance,
    preferred_stock_issuance,
    amortization_of_securities,
    change_in_income_tax_payable,
    change_in_tax_payable,
    dividend_paid_cfo,
    preferred_stock_dividend_paid,
    cash_from_discontinued_operating_activities,
    preferred_stock_payments,
    cash_from_discontinued_investing_activities,
    change_in_interest_payable,
    cash_from_discontinued_financing_activities,
    other_cash_receiptsfrom_operating_activities,
    cash_flow_from_discontinued_operation,
    interest_received_direct,
    excess_tax_benefit_from_stock_based_compensation,
    depletion,
    change_in_dividend_payable,
    receiptsfrom_government_grants,
    dividends_received_direct,
    net_short_term_debt_issuance,
    dividends_paid_direct,
    row_number() over (partition by date, ticker order by _sdc_batched_at desc) as rn
  from
    {{ source('tap_yfinance_dev', 'cash_flow') }}
)

select
  date,
  ticker,
  beginning_cash_position,
  capital_expenditure,
  cash_flow_from_continuing_financing_activities,
  cash_flow_from_continuing_investing_activities,
  cash_flow_from_continuing_operating_activities,
  change_in_account_payable,
  change_in_inventory,
  change_in_other_current_assets,
  change_in_other_current_liabilities,
  change_in_payable,
  change_in_payables_and_accrued_expense,
  change_in_receivables,
  change_in_working_capital,
  changes_in_account_receivables,
  changes_in_cash,
  common_stock_payments,
  depreciation_amortization_depletion,
  depreciation_and_amortization,
  end_cash_position,
  financing_cash_flow,
  free_cash_flow,
  income_tax_paid_supplemental_data,
  interest_paid_supplemental_data,
  investing_cash_flow,
  issuance_of_debt,
  long_term_debt_issuance,
  long_term_debt_payments,
  net_common_stock_issuance,
  net_income_from_continuing_operations,
  net_investment_purchase_and_sale,
  net_issuance_payments_of_debt,
  net_long_term_debt_issuance,
  net_other_financing_charges,
  net_other_investing_changes,
  net_ppe_purchase_and_sale,
  operating_cash_flow,
  other_non_cash_items,
  purchase_of_investment,
  purchase_of_ppe,
  repayment_of_debt,
  repurchase_of_capital_stock,
  sale_of_investment,
  stock_based_compensation,
  purchase_of_business,
  sale_of_ppe,
  common_stock_dividend_paid,
  deferred_tax,
  change_in_other_working_capital,
  change_in_prepaid_assets,
  cash_dividends_paid,
  effect_of_exchange_rate_changes,
  short_term_debt_payments,
  deferred_income_tax,
  net_business_purchase_and_sale,
  unrealized_gain_loss_on_investment_securities,
  asset_impairment_charge,
  change_in_accrued_expense,
  amortization_cash_flow,
  depreciation,
  dividend_received_cfo,
  gain_loss_on_investment_securities,
  gain_loss_on_sale_of_ppe,
  interest_paid_cfo,
  interest_received_cfo,
  net_foreign_currency_exchange_gain_loss,
  net_intangibles_purchase_and_sale,
  net_investment_properties_purchase_and_sale,
  other_cash_adjustment_outside_changein_cash,
  pension_and_employee_benefit_expense,
  provisionand_write_offof_assets,
  purchase_of_intangibles,
  purchase_of_investment_properties,
  sale_of_intangibles,
  short_term_debt_issuance,
  taxes_refund_paid,
  classesof_cash_payments,
  cash_flowsfromusedin_operating_activities_direct,
  classesof_cash_receiptsfrom_operating_activities,
  interest_paid_cff,
  interest_received_cfi,
  other_cash_paymentsfrom_operating_activities,
  paymentson_behalfof_employees,
  paymentsto_suppliersfor_goodsand_services,
  receiptsfrom_customers,
  taxes_refund_paid_direct,
  sale_of_business,
  common_stock_issuance,
  issuance_of_capital_stock,
  sale_of_investment_properties,
  dividends_received_cfi,
  amortization_of_intangibles,
  operating_gains_losses,
  proceeds_from_stock_option_exercised,
  capital_expenditure_reported,
  interest_paid_direct,
  earnings_losses_from_equity_investments,
  gain_loss_on_sale_of_business,
  other_cash_adjustment_inside_changein_cash,
  net_preferred_stock_issuance,
  preferred_stock_issuance,
  amortization_of_securities,
  change_in_income_tax_payable,
  change_in_tax_payable,
  dividend_paid_cfo,
  preferred_stock_dividend_paid,
  cash_from_discontinued_operating_activities,
  preferred_stock_payments,
  cash_from_discontinued_investing_activities,
  change_in_interest_payable,
  cash_from_discontinued_financing_activities,
  other_cash_receiptsfrom_operating_activities,
  cash_flow_from_discontinued_operation,
  interest_received_direct,
  excess_tax_benefit_from_stock_based_compensation,
  depletion,
  change_in_dividend_payable,
  receiptsfrom_government_grants,
  dividends_received_direct,
  net_short_term_debt_issuance,
  dividends_paid_direct
from
  cte
where
  rn = 1
  {% if is_incremental() %}
    and timestamp >= (select max(timestamp) from {{ this }})
  {% endif %}

order by 1