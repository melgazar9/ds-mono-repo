{{ config(schema='yfinance_clean', materialized='incremental', unique_key=['date', 'ticker']) }}

with cte as (
  select
    date,
    ticker,
    capital_stock,
    current_capital_lease_obligation,
    payables_and_accrued_expenses,
    leases,
    common_stock,
    other_current_borrowings,
    other_current_liabilities,
    machinery_furniture_equipment,
    working_capital,
    other_equity_adjustments,
    total_debt,
    inventory,
    gains_losses_not_affecting_retained_earnings,
    current_deferred_revenue,
    cash_financial,
    retained_earnings,
    current_debt_and_capital_lease_obligation,
    other_non_current_assets,
    capital_lease_obligations,
    total_non_current_liabilities_net_minority_interest,
    cash_equivalents,
    payables,
    prepaid_assets,
    available_for_sale_securities,
    tangible_book_value,
    gross_accounts_receivable,
    investments_and_advances,
    other_current_assets,
    other_intangible_assets,
    accounts_receivable,
    total_non_current_assets,
    net_debt,
    net_ppe,
    land_and_improvements,
    investmentin_financial_assets,
    other_receivables,
    long_term_debt_and_capital_lease_obligation,
    cash_cash_equivalents_and_short_term_investments,
    stockholders_equity,
    total_liabilities_net_minority_interest,
    ordinary_shares_number,
    other_properties,
    share_issued,
    receivables,
    cash_and_cash_equivalents,
    long_term_debt,
    commercial_paper,
    accumulated_depreciation,
    treasury_shares_number,
    current_liabilities,
    dueto_related_parties_current,
    allowance_for_doubtful_accounts_receivable,
    construction_in_progress,
    current_assets,
    buildings_and_improvements,
    goodwill,
    common_stock_equity,
    other_payable,
    properties,
    additional_paid_in_capital,
    total_assets,
    other_investments,
    total_equity_gross_minority_interest,
    pensionand_other_post_retirement_benefit_plans_current,
    long_term_capital_lease_obligation,
    invested_capital,
    total_capitalization,
    goodwill_and_other_intangible_assets,
    long_term_equity_investment,
    current_debt,
    accounts_payable,
    other_non_current_liabilities,
    total_tax_payable,
    current_accrued_expenses,
    current_deferred_liabilities,
    tradeand_other_payables_non_current,
    gross_ppe,
    other_short_term_investments,
    net_tangible_assets,
    minority_interest,
    other_equity_interest,
    non_current_pension_and_other_postretirement_benefit_plans,
    non_current_deferred_taxes_liabilities,
    current_provisions,
    non_current_prepaid_assets,
    non_current_deferred_taxes_assets,
    financial_assets,
    financial_assets_designatedas_fair_value_through_profitor_loss_,
    investmentsin_associatesat_cost,
    hedging_assets_current,
    finished_goods,
    work_in_process,
    raw_materials,
    taxes_receivable,
    preferred_shares_number,
    preferred_stock_equity,
    preferred_stock,
    derivative_product_liabilities,
    non_current_deferred_revenue,
    long_term_provisions,
    investments_in_other_ventures_under_equity_method,
    investment_properties,
    assets_held_for_sale_current,
    inventories_adjustments_allowances,
    other_inventories,
    fixed_assets_revaluation_reserve,
    held_to_maturity_securities,
    investmentsin_joint_venturesat_cost,
    receivables_adjustments_allowances,
    defined_pension_benefit,
    non_current_accrued_expenses,
    treasury_stock,
    investmentsin_subsidiariesat_cost,
    restricted_cash,
    current_deferred_taxes_liabilities,
    employee_benefits,
    non_current_deferred_liabilities,
    dividends_payable,
    income_tax_payable,
    non_current_deferred_assets,
    non_current_accounts_receivable,
    trading_securities,
    line_of_credit,
    interest_payable,
    non_current_note_receivables,
    loans_receivable,
    preferred_securities_outside_stock_equity,
    duefrom_related_parties_non_current,
    duefrom_related_parties_current,
    accrued_interest_receivable,
    current_deferred_assets,
    foreign_currency_translation_adjustments,
    liabilities_heldfor_sale_non_current,
    current_deferred_taxes_assets,
    minimum_pension_liabilities,
    current_notes_payable,
    notes_receivable,
    unrealized_gain_loss,
    general_partnership_capital,
    limited_partnership_capital,
    total_partnership_capital,
    dueto_related_parties_non_current,
    restricted_common_stock,
    other_capital_stock,
    financial_assets_designatedas_fv_thru_profitor_loss_total,
    row_number() over (partition by date, ticker order by _sdc_batched_at desc) as rn
  from
    {{ source('tap_yfinance_dev', 'balance_sheet') }}
)

select
  date,
  ticker,
  capital_stock,
  current_capital_lease_obligation,
  payables_and_accrued_expenses,
  leases,
  common_stock,
  other_current_borrowings,
  other_current_liabilities,
  machinery_furniture_equipment,
  working_capital,
  other_equity_adjustments,
  total_debt,
  inventory,
  gains_losses_not_affecting_retained_earnings,
  current_deferred_revenue,
  cash_financial,
  retained_earnings,
  current_debt_and_capital_lease_obligation,
  other_non_current_assets,
  capital_lease_obligations,
  total_non_current_liabilities_net_minority_interest,
  cash_equivalents,
  payables,
  prepaid_assets,
  available_for_sale_securities,
  tangible_book_value,
  gross_accounts_receivable,
  investments_and_advances,
  other_current_assets,
  other_intangible_assets,
  accounts_receivable,
  total_non_current_assets,
  net_debt,
  net_ppe,
  land_and_improvements,
  investmentin_financial_assets,
  other_receivables,
  long_term_debt_and_capital_lease_obligation,
  cash_cash_equivalents_and_short_term_investments,
  stockholders_equity,
  total_liabilities_net_minority_interest,
  ordinary_shares_number,
  other_properties,
  share_issued,
  receivables,
  cash_and_cash_equivalents,
  long_term_debt,
  commercial_paper,
  accumulated_depreciation,
  treasury_shares_number,
  current_liabilities,
  dueto_related_parties_current,
  allowance_for_doubtful_accounts_receivable,
  construction_in_progress,
  current_assets,
  buildings_and_improvements,
  goodwill,
  common_stock_equity,
  other_payable,
  properties,
  additional_paid_in_capital,
  total_assets,
  other_investments,
  total_equity_gross_minority_interest,
  pensionand_other_post_retirement_benefit_plans_current,
  long_term_capital_lease_obligation,
  invested_capital,
  total_capitalization,
  goodwill_and_other_intangible_assets,
  long_term_equity_investment,
  current_debt,
  accounts_payable,
  other_non_current_liabilities,
  total_tax_payable,
  current_accrued_expenses,
  current_deferred_liabilities,
  tradeand_other_payables_non_current,
  gross_ppe,
  other_short_term_investments,
  net_tangible_assets,
  minority_interest,
  other_equity_interest,
  non_current_pension_and_other_postretirement_benefit_plans,
  non_current_deferred_taxes_liabilities,
  current_provisions,
  non_current_prepaid_assets,
  non_current_deferred_taxes_assets,
  financial_assets,
  financial_assets_designatedas_fair_value_through_profitor_loss_,
  investmentsin_associatesat_cost,
  hedging_assets_current,
  finished_goods,
  work_in_process,
  raw_materials,
  taxes_receivable,
  preferred_shares_number,
  preferred_stock_equity,
  preferred_stock,
  derivative_product_liabilities,
  non_current_deferred_revenue,
  long_term_provisions,
  investments_in_other_ventures_under_equity_method,
  investment_properties,
  assets_held_for_sale_current,
  inventories_adjustments_allowances,
  other_inventories,
  fixed_assets_revaluation_reserve,
  held_to_maturity_securities,
  investmentsin_joint_venturesat_cost,
  receivables_adjustments_allowances,
  defined_pension_benefit,
  non_current_accrued_expenses,
  treasury_stock,
  investmentsin_subsidiariesat_cost,
  restricted_cash,
  current_deferred_taxes_liabilities,
  employee_benefits,
  non_current_deferred_liabilities,
  dividends_payable,
  income_tax_payable,
  non_current_deferred_assets,
  non_current_accounts_receivable,
  trading_securities,
  line_of_credit,
  interest_payable,
  non_current_note_receivables,
  loans_receivable,
  preferred_securities_outside_stock_equity,
  duefrom_related_parties_non_current,
  duefrom_related_parties_current,
  accrued_interest_receivable,
  current_deferred_assets,
  foreign_currency_translation_adjustments,
  liabilities_heldfor_sale_non_current,
  current_deferred_taxes_assets,
  minimum_pension_liabilities,
  current_notes_payable,
  notes_receivable,
  unrealized_gain_loss,
  general_partnership_capital,
  limited_partnership_capital,
  total_partnership_capital,
  dueto_related_parties_non_current,
  restricted_common_stock,
  other_capital_stock,
  financial_assets_designatedas_fv_thru_profitor_loss_total
from
  cte
where
  rn = 1
  {% if is_incremental() %}
    and date >= (select max(date) from {{ this }})
  {% endif %}

order by 1