{{ config(schema='yfinance_clean', materialized='table', unique_key=['ticker', 'date']) }}

with cte as (
  select distinct
    *,
    row_number() over(partition by date, ticker order by _sdc_batched_at desc) as rn
  from
    {{ source('tap_yfinance_dev', 'income_stmt') }}
)

select
  date,
  ticker,
  basic_average_shares,
  basic_eps,
  cost_of_revenue,
  diluted_average_shares,
  diluted_eps,
  diluted_ni_availto_com_stockholders,
  ebit,
  ebitda,
  gross_profit,
  interest_expense,
  interest_expense_non_operating,
  interest_income_non_operating,
  net_income,
  net_income_common_stockholders,
  net_income_continuous_operations,
  net_income_from_continuing_and_discontinued_operation,
  net_income_from_continuing_operation_net_minority_interest,
  net_income_including_noncontrolling_interests,
  net_interest_income,
  net_non_operating_interest_income_expense,
  normalized_ebitda,
  normalized_income,
  operating_expense,
  operating_income,
  operating_revenue,
  other_income_expense,
  other_non_operating_income_expenses,
  pretax_income,
  reconciled_cost_of_revenue,
  reconciled_depreciation,
  research_and_development,
  selling_general_and_administration,
  tax_effect_of_unusual_items,
  tax_provision,
  tax_rate_for_calcs,
  total_expenses,
  total_operating_income_as_reported,
  total_revenue,
  interest_income,
  special_income_charges,
  depreciation_and_amortization_in_income_statement,
  depreciation_amortization_depletion_income_statement,
  selling_and_marketing_expense,
  gain_on_sale_of_ppe,
  general_and_administrative_expense,
  other_gand_a,
  write_off,
  amortization_of_intangibles_income_statement,
  other_operating_expenses,
  total_unusual_items_excluding_goodwill,
  amortization,
  total_unusual_items,
  minority_interests,
  gain_on_sale_of_security,
  otherunder_preferred_stock_dividend,
  total_other_finance_cost,
  depreciation_income_statement,
  impairment_of_capital_assets,
  other_special_charges,
  rent_and_landing_fees,
  rent_expense_supplemental,
  restructuring_and_mergern_acquisition,
  net_income_discontinuous_operations,
  gain_on_sale_of_business,
  salaries_and_wages,
  earnings_from_equity_interest_net_of_tax,
  average_dilution_earnings,
  preferred_stock_dividends,
  insurance_and_claims,
  earnings_from_equity_interest,
  other_taxes,
  net_income_extraordinary,
  provision_for_doubtful_accounts,
  securities_amortization,
  excise_taxes,
  net_income_from_tax_loss_carryforward,
  depletion_income_statement,
  depreciation
from
  cte
where
  rn = 1